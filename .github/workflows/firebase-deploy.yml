name: Firebase Functions Deploy

on:
  workflow_dispatch:
  push:
    paths:
      - 'functions/**'
      - 'firebase.json'
      - '.firebaserc'
      - '.github/workflows/firebase-functions-deploy.yml'

jobs:
  deploy-functions:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Functions dependencies
        working-directory: functions
        run: npm ci

      - name: Diagnostics â€” verify firebase.json at repo root
        run: |
          echo "Working directory:" && pwd
          echo "List root:" && ls -la
          test -f firebase.json && echo "Found firebase.json" || (echo "Missing firebase.json" && exit 1)
          test -f .firebaserc && echo "Found .firebaserc" || echo "No .firebaserc (ok if project is set in firebase.json)"

      - name: Set Functions config (Geo keys)
        uses: w9jds/firebase-action@v13
        with:
          args: functions:config:set maps.geoapify_key="${{ secrets.GEOAPIFY_KEY }}"
        env:
          GCP_SA_KEY: ${{ secrets.FIREBASE_DEPLOY_KEY }}

      - name: Deploy Cloud Functions
        uses: w9jds/firebase-action@v13
        with:
          args: deploy --only functions --config firebase.json --non-interactive
        env:
          GCP_SA_KEY: ${{ secrets.FIREBASE_DEPLOY_KEY }}
