name: One-time: Set backfill.run_secret

on:
  workflow_dispatch:
    inputs:
      secret_override:
        description: Optional override for the secret; leave blank to use repo secret BACKFILL_RUN_SECRET
        required: false

jobs:
  set-secret:
    runs-on: ubuntu-latest
    env:
      BACKFILL_RUN_SECRET: ${{ inputs.secret_override != '' && inputs.secret_override || secrets.BACKFILL_RUN_SECRET }}
      PROJECT_ID: courthub-app
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Google auth (service account)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_DEPLOY_KEY }}
          token_format: access_token

      - name: Install Firebase CLI (v13)
        run: npm install -g firebase-tools@13

      - name: Assert secret value is present
        run: |
          if [ -z "${BACKFILL_RUN_SECRET}" ]; then
            echo "BACKFILL_RUN_SECRET is missing. Add repo secret or provide secret_override input."
            exit 1
          fi

      - name: Set Functions config backfill.run_secret
        run: |
          firebase --project "${PROJECT_ID}" functions:config:set backfill.run_secret="${BACKFILL_RUN_SECRET}"

      - name: Verify backfill.run_secret is set (value hidden)
        run: |
          firebase --project "${PROJECT_ID}" functions:config:get | node -e "let d='';process.stdin.on('data',c=>d+=c).on('end',()=>{const j=JSON.parse(d||'{}'); if(!j.backfill||!j.backfill.run_secret){console.error('Missing backfill.run_secret after set'); process.exit(2)} else {console.log('backfill.run_secret is set. (value hidden)')}})"
