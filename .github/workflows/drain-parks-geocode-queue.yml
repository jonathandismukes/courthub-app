name: Drain Parks Geocode Queue

on:
  schedule:
    - cron: '*/2 * * * *'
  workflow_dispatch: {}

# Prevent overlapping runs. If a new run starts while another is running,
# the older one will be allowed to finish (no cancel).
concurrency:
  group: drain-parks-geocode-queue
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Invoke drain function
        env:
          # Project fixed per handoff: courthub-app (region us-central1)
          FUNCTION_URL: https://us-central1-courthub-app.cloudfunctions.net/drainParksGeocodeQueueHttp
          BACKFILL_RUN_SECRET: ${{ secrets.BACKFILL_RUN_SECRET }}
        run: |
          if [ -z "$BACKFILL_RUN_SECRET" ]; then
            echo "Missing secrets.BACKFILL_RUN_SECRET" && exit 1
          fi
          # Force POST with small JSON body; fail on non-2xx and show errors
          curl --fail --show-error -sS -X POST "$FUNCTION_URL?limit=25" \
            -H "x-run-secret: $BACKFILL_RUN_SECRET" \
            -H "Content-Type: application/json" \
            -d '{}'

